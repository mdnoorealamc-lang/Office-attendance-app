
import React, { useState, useEffect } from 'react';
import Header from './components/Header';
import EmployeeForm from './components/EmployeeForm';
import AdminDashboard from './components/AdminDashboard';
import GoogleScriptInstructions from './components/GoogleScriptInstructions';
import AdminLoginModal from './components/AdminLoginModal';
import { AttendanceAction, LocationData, Employee, AttendanceRecord } from './types';
import { storageService } from './services/storageService';
import { REMOTE_URL_KEY, ORG_NAME } from './constants';

const App: React.FC = () => {
  const [isAdmin, setIsAdmin] = useState(false);
  const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
  const [showInstructions, setShowInstructions] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null);

  useEffect(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  }, [message]);

  const handleAdminToggle = () => {
    if (isAdmin) {
      setIsAdmin(false);
      setShowInstructions(false);
    } else {
      setIsLoginModalOpen(true);
    }
  };

  const handleAttendanceSubmit = async (action: AttendanceAction, location: LocationData, employee: Employee) => {
    const newRecord: AttendanceRecord = {
      id: Math.random().toString(36).substr(2, 9),
      employeeName: employee.name,
      email: employee.email,
      action: action,
      timestamp: new Date().toISOString(),
      location: location
    };

    try {
      storageService.saveRecord(newRecord);
    } catch (e) {
      console.error("Local storage error:", e);
    }

    const remoteUrl = localStorage.getItem(REMOTE_URL_KEY);
    let remoteStatus = "";

    if (remoteUrl) {
      try {
        await fetch(remoteUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newRecord)
        });
        remoteStatus = " & Synced to Google Sheet";
      } catch (err) {
        console.error("Remote sync failed:", err);
        remoteStatus = " (Saved locally, remote sync failed)";
      }
    }

    setMessage({ 
      type: 'success', 
      text: `Attendance recorded: ${action} for ${employee.name}${remoteStatus}` 
    });
  };

  return (
    <div className="min-h-screen flex flex-col bg-slate-50/50">
      <Header onAdminClick={handleAdminToggle} isAdmin={isAdmin} />

      <AdminLoginModal 
        isOpen={isLoginModalOpen} 
        onClose={() => setIsLoginModalOpen(false)} 
        onSuccess={() => setIsAdmin(true)} 
      />

      <main className="flex-grow">
        {message && (
          <div className={`fixed top-24 right-4 z-[100] animate-bounce-in`}>
            <div className={`px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border ${
              message.type === 'success' ? 'bg-green-600 border-green-500' : 'bg-red-600 border-red-500'
            } text-white`}>
              <i className={`fa-solid ${message.type === 'success' ? 'fa-circle-check' : 'fa-circle-xmark'}`}></i>
              <p className="font-bold text-sm">{message.text}</p>
            </div>
          </div>
        )}

        {isAdmin ? (
          <div className="animate-fade-in">
            <AdminDashboard />
            <div className="text-center pb-12">
              <button 
                onClick={() => setShowInstructions(!showInstructions)}
                className="text-indigo-600 hover:text-indigo-800 text-sm font-medium underline"
              >
                {showInstructions ? 'Hide Setup Instructions' : 'Show Google Sheets Setup Instructions'}
              </button>
            </div>
            {showInstructions && <GoogleScriptInstructions />}
          </div>
        ) : (
          <div className="py-12 px-4 animate-fade-in">
            <EmployeeForm onSubmit={handleAttendanceSubmit} />
            
            <div className="max-w-md mx-auto mt-12 text-center text-gray-500">
              <div className="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-widest mb-4">
                <i className="fa-solid fa-shield-halved text-indigo-400"></i>
                Secure Environment
              </div>
              <p className="text-xs leading-relaxed px-4">
                This portal is encrypted. Your GPS location is captured only at the moment of submission to verify your attendance status.
              </p>
            </div>
          </div>
        )}
      </main>

      <footer className="bg-white border-t border-gray-100 py-8">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <p className="text-gray-400 text-[10px] font-bold uppercase tracking-widest">
            &copy; {new Date().getFullYear()} {ORG_NAME}. All rights reserved.
          </p>
          <p className="text-gray-300 text-[9px] mt-1 font-medium">
            Providing Rural Primary Healthcare Initiatives with Smart Solutions.
          </p>
        </div>
      </footer>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes bounce-in {
          0% { transform: scale(0.9) translateY(-20px); opacity: 0; }
          70% { transform: scale(1.05) translateY(5px); opacity: 1; }
          100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .animate-bounce-in {
          animation: bounce-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-out forwards;
        }
      `}} />
    </div>
  );
};

export default App;
